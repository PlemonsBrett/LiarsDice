name: Style

# This workflow is integrated into the main CI workflow (.github/workflows/ci.yml)
# It can still run independently for style-only checks

on:
  workflow_dispatch:  # Allow manual trigger
  workflow_call:      # Allow being called from other workflows

env:
  CPM_SOURCE_CACHE: ${{ github.workspace }}/cpm_modules

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/cache@v4
        with:
          path: "**/cpm_modules"
          key: ${{ github.workflow }}-cpm-modules-${{ hashFiles('**/CMakeLists.txt', '**/*.cmake') }}

      - name: Install format dependencies
        run: |
          # Install clang-format-20 for consistent formatting with local development
          wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | sudo apt-key add -
          sudo add-apt-repository "deb http://apt.llvm.org/$(lsb_release -cs)/ llvm-toolchain-$(lsb_release -cs)-20 main"
          sudo apt-get update
          sudo apt-get install -y clang-format-20 libboost-all-dev
          sudo ln -sf /usr/bin/clang-format-20 /usr/local/bin/clang-format
          pip3 install cmake_format==0.6.11 pyyaml
          echo "Using clang-format version:"
          clang-format --version

      - name: Check C++ formatting
        run: |
          echo "Checking C++ code formatting..."
          find include source standalone test -name "*.cpp" -o -name "*.hpp" | \
          xargs clang-format --dry-run --Werror 2>&1 | tee format_check.log || true
          if grep -q "error:" format_check.log; then
            echo "::error::C++ formatting issues found. Run 'clang-format -i' on affected files."
            cat format_check.log
            exit 1
          else
            echo "C++ formatting check passed!"
          fi

      - name: Check CMake formatting
        run: |
          find . -name "CMakeLists.txt" -o -name "*.cmake" | \
          grep -v build | grep -v cpm_modules | \
          xargs cmake-format --check 2>&1 | tee cmake_format_check.log
          if grep -q "would be reformatted" cmake_format_check.log; then
            echo "CMake formatting issues found!"
            exit 1
          fi